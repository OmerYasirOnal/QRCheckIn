<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Kod - Yoklama Sistemi</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container wide">
        <div class="header">
            <div class="header-content">
                <h1>ğŸ“± QR Kod ile Yoklama</h1>
                <p>Ã–ÄŸrenciler QR kodu okutarak yoklama yapabilir</p>
            </div>
            <button class="btn btn-secondary" onclick="goBack()">â¬…ï¸ Geri DÃ¶n</button>
        </div>
        
        <div id="lessonInfo" class="info-card">
            <h3>ğŸ“š Ders Bilgileri</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
                <div>
                    <p><strong>Ders AdÄ±:</strong> <span id="lessonName">YÃ¼kleniyor...</span></p>
                    <p><strong>Ã–ÄŸretmen:</strong> <span id="teacherName">YÃ¼kleniyor...</span></p>
                </div>
                <div>
                    <p><strong>Tarih:</strong> <span id="lessonDate">YÃ¼kleniyor...</span></p>
                    <p><strong>Ders ID:</strong> <span id="lessonId">YÃ¼kleniyor...</span></p>
                </div>
            </div>
        </div>
        
        <div class="qr-container">
            <h2>ğŸ“² Ã–ÄŸrenciler Bu QR Kodu Okutun</h2>
            <div id="qrcode"></div>
            <div id="qrMessage">
                <p style="margin-top: var(--space-4); color: var(--gray-600);">
                    QR kodu telefonunuzla okutarak yoklama sayfasÄ±na eriÅŸebilirsiniz.
                </p>
            </div>
            
            <div class="info-card">
                <h3>ğŸ’¡ NasÄ±l KullanÄ±lÄ±r?</h3>
                <p><strong>1.</strong> Ã–ÄŸrenciler QR kodu telefonlarÄ±ndaki kamera uygulamasÄ± ile okutacaklar</p>
                <p><strong>2.</strong> Otomatik olarak yoklama sayfasÄ±na yÃ¶nlendirilecekler</p>
                <p><strong>3.</strong> Ad ve soyadlarÄ±nÄ± girerek yoklama yapacaklar</p>
                <p><strong>4.</strong> Her cihazdan sadece bir kez yoklama yapÄ±labilir</p>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">KatÄ±lan Ã–ÄŸrenci</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastUpdate">-</div>
                <div class="stat-label">Son GÃ¼ncelleme</div>
            </div>
        </div>
        
        <div style="margin: var(--space-8) 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); flex-wrap: wrap; gap: var(--space-4);">
                <h2>ğŸ‘¥ AnlÄ±k Yoklama Listesi</h2>
                <div style="display: flex; gap: var(--space-2);">
                    <button class="btn btn-sm btn-outline" onclick="refreshAttendance()">ğŸ”„ Yenile</button>
                    <button class="btn btn-sm" onclick="generateNewQR()">ğŸ”„ Yeni QR Kod</button>
                    <button class="btn btn-sm btn-danger" onclick="invalidateQR()" id="invalidateBtn">âŒ QR GeÃ§ersiz KÄ±l</button>
                </div>
            </div>
            <div id="attendanceList" class="attendance-list">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <p>Yoklama listesi yÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
        
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        let lessonId = '';
        let refreshInterval;
        let currentUser = null;
        let currentToken = null;
        let isLessonInvalidated = false;
        
        window.onload = async function() {
            // Token ve kullanÄ±cÄ± bilgilerini kontrol et
            currentToken = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!currentToken || !userStr) {
                alert('GiriÅŸ yapmanÄ±z gerekiyor!');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(userStr);
            } catch (error) {
                console.error('KullanÄ±cÄ± bilgileri parse edilemedi:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                return;
            }
            
            // QR kod kÃ¼tÃ¼phanesinin yÃ¼klendiÄŸini kontrol et
            if (typeof QRCode === 'undefined') {
                console.error('QRCode kÃ¼tÃ¼phanesi yÃ¼klenmedi!');
                document.getElementById('qrcode').innerHTML = `
                    <div class="message error">
                        âŒ QR kod kÃ¼tÃ¼phanesi yÃ¼klenemedi!<br>
                        <small>LÃ¼tfen sayfayÄ± yenileyin veya internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</small>
                    </div>
                `;
                return;
            }
            
            // URL'den lesson ID'yi al
            const urlParams = new URLSearchParams(window.location.search);
            lessonId = urlParams.get('lessonId');
            
            if (!lessonId) {
                alert('Ders ID bulunamadÄ±!');
                window.location.href = 'teacher.html';
                return;
            }
            
            document.getElementById('lessonId').textContent = lessonId;
            
            // Ders bilgilerini al
            await loadLessonInfo();
            
            // QR kod oluÅŸtur
            generateQRCode();
            
            // Ä°lk yoklama listesini yÃ¼kle
            await loadAttendanceList();
            
            // 5 saniyede bir yoklama listesini yenile
            refreshInterval = setInterval(loadAttendanceList, 5000);
        };
        
        // Sayfa kapatÄ±ldÄ±ÄŸÄ±nda interval'Ä± temizle
        window.onbeforeunload = function() {
            if (refreshInterval) clearInterval(refreshInterval);
        };
        
        // API isteÄŸi yapma fonksiyonu
        async function makeAuthenticatedRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                }
            };
            
            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, mergedOptions);
            
            if (response.status === 401 || response.status === 403) {
                // Token geÃ§ersiz, giriÅŸ sayfasÄ±na yÃ¶nlendir
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                alert('Oturum sÃ¼resi doldu. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
                window.location.href = 'index.html';
                return null;
            }
            
            return response;
        }
        
        async function loadLessonInfo() {
            try {
                const response = await fetch(`/lesson/${lessonId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('lessonName').textContent = data.lesson.name;
                    document.getElementById('teacherName').textContent = data.lesson.teacher_name;
                    const date = new Date(data.lesson.date).toLocaleDateString('tr-TR', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    document.getElementById('lessonDate').textContent = date;
                    
                    // Invalidation status kontrol et
                    isLessonInvalidated = data.lesson.is_invalidated;
                    updateUIForInvalidation();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Ders bilgileri yÃ¼klenirken hata:', error);
                showMessage('Ders bilgileri yÃ¼klenemedi: ' + error.message, 'error');
            }
        }
        
        function generateQRCode() {
            const qrData = `${window.location.origin}/student.html?lessonId=${lessonId}`;
            
            try {
                // QR kod container'Ä±nÄ± temizle
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                
                // Yeni QR kod oluÅŸtur
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 300,
                    height: 300,
                    colorDark: '#000000',
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                console.log('QR kod baÅŸarÄ±yla oluÅŸturuldu:', qrData);
            } catch (error) {
                console.error('QR kod oluÅŸturma hatasÄ±:', error);
                document.getElementById('qrcode').innerHTML = `
                    <div class="message error">
                        âŒ QR kod oluÅŸturulamadÄ±!<br>
                        <small>Hata: ${error.message}</small>
                    </div>
                `;
            }
        }
        
        async function loadAttendanceList() {
            try {
                const response = await makeAuthenticatedRequest(`/attendanceList/${lessonId}`);
                if (!response) return;
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalStudents').textContent = data.total;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const attendanceContainer = document.getElementById('attendanceList');
                    
                    if (data.attendances.length === 0) {
                        attendanceContainer.innerHTML = `
                            <div class="empty-state">
                                <h3>ğŸ‘¥ HenÃ¼z yoklama yapan Ã¶ÄŸrenci yok</h3>
                                <p>QR kod paylaÅŸÄ±ldÄ±ÄŸÄ±nda Ã¶ÄŸrenciler burada gÃ¶rÃ¼necek.</p>
                            </div>
                        `;
                    } else {
                        const attendanceHtml = data.attendances.map((attendance, index) => `
                            <div class="attendance-item">
                                <div class="student-info">
                                    <span class="attendance-number">${index + 1}</span>
                                    <span class="student-name">${attendance.student_name}</span>
                                </div>
                                <span class="attendance-time">${formatTime(attendance.created_at)}</span>
                            </div>
                        `).join('');
                        
                        attendanceContainer.innerHTML = attendanceHtml;
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Yoklama listesi yÃ¼klenirken hata:', error);
                document.getElementById('attendanceList').innerHTML = `
                    <div class="message error">
                        <strong>Hata!</strong> Yoklama listesi yÃ¼klenemedi: ${error.message}
                    </div>
                `;
            }
        }
        
        // QR kodu geÃ§ersiz kÄ±l
        async function invalidateQR() {
            if (!confirm('QR kodu geÃ§ersiz kÄ±lmak istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz ve Ã¶ÄŸrenciler artÄ±k bu QR kodla yoklama yapamayacaklar.')) {
                return;
            }
            
            try {
                showMessage('â³ QR kod geÃ§ersiz kÄ±lÄ±nÄ±yor...', 'info');
                
                const response = await makeAuthenticatedRequest(`/invalidateQR/${lessonId}`, {
                    method: 'POST'
                });
                
                if (!response) return;
                
                const data = await response.json();
                
                if (data.success) {
                    isLessonInvalidated = true;
                    updateUIForInvalidation();
                    showMessage('âœ… QR kod baÅŸarÄ±yla geÃ§ersiz kÄ±lÄ±ndÄ±.', 'success');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showMessage('âš ï¸ QR kod geÃ§ersiz kÄ±lÄ±nÄ±rken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        // UI'Ä± invalidation durumuna gÃ¶re gÃ¼ncelle
        function updateUIForInvalidation() {
            const qrContainer = document.getElementById('qrcode');
            const qrMessage = document.getElementById('qrMessage');
            const invalidateBtn = document.getElementById('invalidateBtn');
            
            if (isLessonInvalidated) {
                // QR kod alanÄ±nÄ± gizle ve geÃ§ersiz mesajÄ± gÃ¶ster
                qrContainer.innerHTML = `
                    <div class="message error" style="text-align: center; padding: var(--space-8);">
                        <h3>âŒ QR Kod GeÃ§ersiz KÄ±lÄ±ndÄ±</h3>
                        <p>Bu QR kod Ã¶ÄŸretmen tarafÄ±ndan geÃ§ersiz kÄ±lÄ±nmÄ±ÅŸtÄ±r.<br>
                        Ã–ÄŸrenciler artÄ±k bu QR kodla yoklama yapamaz.</p>
                    </div>
                `;
                
                qrMessage.innerHTML = `
                    <div class="info-card warning" style="margin-top: var(--space-4);">
                        <h3>âš ï¸ Dikkat</h3>
                        <p><strong>Bu QR kod geÃ§ersiz kÄ±lÄ±nmÄ±ÅŸtÄ±r.</strong></p>
                        <p>Mevcut yoklama listesi korunur ancak yeni Ã¶ÄŸrenciler yoklama yapamaz.</p>
                        <p>Yeni yoklama iÃ§in yeni bir ders oluÅŸturmanÄ±z gerekir.</p>
                    </div>
                `;
                
                // Invalidate butonunu gizle
                if (invalidateBtn) {
                    invalidateBtn.style.display = 'none';
                }
                
                // Interval'Ä± durdur (artÄ±k yenilemeye gerek yok)
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            } else {
                // Normal durumda invalidate butonunu gÃ¶ster
                if (invalidateBtn) {
                    invalidateBtn.style.display = 'inline-block';
                }
            }
        }

        // Yeni QR kod oluÅŸtur
        async function generateNewQR() {
            if (!confirm('Yeni QR kod oluÅŸturmak istediÄŸinizden emin misiniz?\n\nBu iÅŸlem mevcut QR kodu geÃ§ersiz kÄ±lacaktÄ±r.')) {
                return;
            }
            
            try {
                showMessage('ğŸ”„ Yeni QR kod oluÅŸturuluyor...', 'info');
                
                // SayfayÄ± yeniden yÃ¼kleyerek yeni QR kod oluÅŸtur
                window.location.reload();
                
            } catch (error) {
                showMessage('âš ï¸ Yeni QR kod oluÅŸturulurken hata oluÅŸtu: ' + error.message, 'error');
            }
        }
        
        function refreshAttendance() {
            loadAttendanceList();
            showMessage('ğŸ”„ Yoklama listesi yenilendi.', 'success');
        }
        
        function formatTime(dateStr) {
            return new Date(dateStr).toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function goBack() {
            // Interval'Ä± temizle
            if (refreshInterval) clearInterval(refreshInterval);
            
            window.location.href = 'teacher.html';
        }
        
        // Mesaj gÃ¶sterme
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = message;
            messageDiv.style.display = 'block';
            
            // Otomatik gizleme
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, type === 'error' ? 6000 : 3000);
        }
        
        // Print fonksiyonu
        function printQR() {
            window.print();
        }
        
        // Klavye kÄ±sayollarÄ±
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                goBack();
            } else if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                refreshAttendance();
            } else if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printQR();
            }
        });
    </script>
</body>
</html> 